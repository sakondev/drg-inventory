<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DragCura Inventory</title>

    <!-- DataTables CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css"
    />

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>

    <!-- xlsx library for exporting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      th {
        background-color: #f2f2f2;
      }
      #branchFilter,
      #exportButton {
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <h1>DragCura Inventory</h1>
    <h5 id="lastUpdated">Last Updated at:</h5>

    <!-- Dropdown for filtering branches -->
    <label for="branchFilter">Select Branch:</label>
    <select id="branchFilter">
      <option value="">All</option>
      <!-- Options will be populated dynamically -->
    </select>

    <!-- Export to Excel Button -->
    <button id="exportButton">Export to Excel</button>

    <!-- Table for DataTables -->
    <table id="inventoryTable" class="display">
      <thead>
        <tr>
          <th style="width: 15%">SKU</th>
          <th style="width: 40%">Item</th>
          <th style="width: 15%">Branch</th>
          <th style="width: 15%">Qty</th>
        </tr>
      </thead>
      <tbody>
        <!-- Data will be dynamically loaded here -->
      </tbody>
    </table>

    <script>
      $(document).ready(function () {
        $.getJSON("inventory_data.json")
          .done(function (data) {
            $("#lastUpdated").text("Last Updated at: " + data.last_updated);

            // Initialize DataTable
            var table = $("#inventoryTable").DataTable({
              data: [],
              columns: [
                { data: "SKU" },
                { data: "Item" },
                { data: "Branch" },
                { data: "Qty" },
              ],
              pageLength: 25,
              lengthMenu: [
                [25, 50, 100, -1],
                [25, 50, 100, "All"],
              ],
              paging: true,
              dom: "<'top'lf>rt<'bottom'i<'clear'>p>",
            });

            // Process inventory data
            var processedData = [];
            data.inventory.forEach((item) => {
              var branches = item.Branch;

              // Loop through branches
              for (var branch in branches) {
                var qty = parseFloat(branches[branch]);

                processedData.push({
                  SKU: item.SKU,
                  Item: item.Item,
                  Branch: branch,
                  Qty: qty,
                });
              }
            });

            // Add data to DataTable
            table.clear().rows.add(processedData).draw();

            // Populate branch filter options with unique branch names
            var branchNames = {};
            processedData.forEach((item) => {
              branchNames[item.Branch] = true; // Store unique branch names
            });
            Object.keys(branchNames).forEach((branch) => {
              $("#branchFilter").append(new Option(branch, branch));
            });

            // Filter by selected branch
            $("#branchFilter").on("change", function () {
              var selectedBranch = $(this).val();
              table
                .column(2) // Column index for "Branch"
                .search(
                  selectedBranch ? "^" + selectedBranch + "$" : "",
                  true,
                  false
                )
                .draw();
            });
          })
          .fail(function () {
            console.error("Failed to load JSON data.");
            alert(
              "Error loading data. Please check the console for more details."
            );
          });

        // Export to Excel
        $("#exportButton").on("click", function () {
          var ws = XLSX.utils.table_to_sheet(
            document.getElementById("inventoryTable")
          );
          var wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "InventoryData");
          XLSX.writeFile(wb, "inventory_data.xlsx");
        });
      });
    </script>
  </body>
</html>
